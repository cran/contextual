<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Robin van Emden" />

<meta name="date" content="2020-03-04" />

<title>Demo: Bandits, Propensity Weighting &amp; Simpson’s Paradox in R</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Demo: Bandits, Propensity Weighting &amp; Simpson’s Paradox in R</h1>
<h4 class="author">Robin van Emden</h4>
<h4 class="date">2020-03-04</h4>



<p>Imagine a website with Sport and Movie related articles where the “actual” preference of men and women for Sport and Movie articles is the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>Contexts   <span class="op">|</span><span class="st"> </span><span class="kw">Sport</span> (arm) <span class="op">|</span><span class="st">  </span><span class="kw">Movie</span> (arm)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">-----------------------------------------</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>Male       <span class="op">|</span><span class="st"> </span><span class="fl">0.4</span>         <span class="op">|</span><span class="st">  </span><span class="fl">0.3</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>Female     <span class="op">|</span><span class="st"> </span><span class="fl">0.8</span>         <span class="op">|</span><span class="st">  </span><span class="fl">0.7</span></span></code></pre></div>
<p>In other words, both Male and Female visitors actually prefer Sports articles over Movie articles. When visitors are randomly assigned to types of articles, the overall CTR rate per category reflects this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>Contexts   <span class="op">|</span><span class="st"> </span><span class="kw">Sport</span> (arm) <span class="op">|</span><span class="st">  </span><span class="kw">Movie</span> (arm)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="op">-----------------------------------------</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>Male       <span class="op">|</span><span class="st"> </span><span class="fl">0.4</span> x <span class="fl">0.5</span>   <span class="op">|</span><span class="st">  </span><span class="fl">0.3</span> x <span class="fl">0.5</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>Female     <span class="op">|</span><span class="st"> </span><span class="fl">0.8</span> x <span class="fl">0.5</span>   <span class="op">|</span><span class="st">  </span><span class="fl">0.7</span> x <span class="fl">0.5</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="op">-----------------------------------------</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>CTR total  <span class="op">|</span><span class="st"> </span><span class="fl">0.6</span>         <span class="op">|</span><span class="st">  </span><span class="fl">0.5</span></span></code></pre></div>
<p>Now suggest the site’s editor just “knows” that men like sports, and women like movie related articles. So the editor has some business logic implemented, assigning Movie related articles, on average, to 75% of Female visitors, and Sports articles, on average, to 75% of Male visitors:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>Contexts   <span class="op">|</span><span class="st"> </span><span class="kw">Sport</span> (arm) <span class="op">|</span><span class="st">  </span><span class="kw">Movie</span> (arm)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="op">-----------------------------------------</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>Male       <span class="op">|</span><span class="st"> </span><span class="fl">0.4</span> x <span class="fl">0.75</span>  <span class="op">|</span><span class="st">  </span><span class="fl">0.3</span> x <span class="fl">0.25</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>Female     <span class="op">|</span><span class="st"> </span><span class="fl">0.8</span> x <span class="fl">0.25</span>  <span class="op">|</span><span class="st">  </span><span class="fl">0.7</span> x <span class="fl">0.75</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="op">-----------------------------------------</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>CTR total  <span class="op">|</span><span class="st"> </span><span class="fl">0.5</span>         <span class="op">|</span><span class="st">  </span><span class="fl">0.6</span></span></code></pre></div>
<p>This results in a higher CTR for movies than for Sports related articles - even though these CTR’s do not actually reflect the overall preferences of website visitors, but rather the editor’s prejudice.</p>
<p>A clear example of <a href="https://en.wikipedia.org/wiki/Simpson%27s_paradox">Simpson’s Paradox</a>!</p>
<p>Below an R code based illustration (making use of our “<a href="https://github.com/Nth-iteration-labs/contextual">contextual</a>” bandit package) of how Simpson’s Paradox could give rise to biased logged data, resulting in biased offline evaluations of bandit policies. Next, we demonstrate how <a href="https://en.wikipedia.org/wiki/Inverse_probability_weighting">inverse propensity weighting</a> can help make such data usable for offline evaluation after all.</p>
<div id="original-bandit-weights" class="section level2">
<h2>Original bandit weights</h2>
<p>Set up simulation bandit weights representing Male and Female actual preferences for Sports and Movies:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a> </span>
<span id="cb4-2"><a href="#cb4-2"></a>horizon                           &lt;-<span class="st"> </span>10000L</span>
<span id="cb4-3"><a href="#cb4-3"></a>simulations                       &lt;-<span class="st"> </span>1L</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#                    S----M------------&gt; Arm 1:   Sport</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#                    |    |              Arm 2:   Movie</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#                    |    |</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>weights &lt;-<span class="st"> </span><span class="kw">matrix</span>( <span class="kw">c</span>(<span class="fl">0.4</span>, <span class="fl">0.3</span>,    <span class="co">#-----&gt; Context: Male</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>                     <span class="fl">0.8</span>, <span class="fl">0.7</span>),   <span class="co">#-----&gt; Context: Female</span></span>
<span id="cb4-10"><a href="#cb4-10"></a> </span>
<span id="cb4-11"><a href="#cb4-11"></a>                     <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>These weights will be fed to contextual’s <a href="https://github.com/Nth-iteration-labs/contextual/blob/master/R/bandit_cmab_bernoulli.R">ContextualBernoulliBandit</a> so it can simulate clicks by Male and Female according to their preferences per category.</p>
</div>
<div id="generate-data-by-running-a-fully-random-online-policy" class="section level2">
<h2>Generate data by running a fully random online policy</h2>
<p>Let’s first run contextual’s basic <a href="https://github.com/Nth-iteration-labs/contextual/blob/master/R/policy_random.R">random policy</a> against the bandit that models actual visitor’s preferences. This random policy assigns Males and Females fully at random to either Sport or Movie articles:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>policy                            &lt;-<span class="st"> </span>RandomPolicy<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb5-2"><a href="#cb5-2"></a>bandit                            &lt;-<span class="st"> </span>ContextualBernoulliBandit<span class="op">$</span><span class="kw">new</span>(<span class="dt">weights =</span> weights)</span>
<span id="cb5-3"><a href="#cb5-3"></a>agent                             &lt;-<span class="st"> </span>Agent<span class="op">$</span><span class="kw">new</span>(policy, bandit, <span class="st">&quot;Random&quot;</span>)</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a>simulation                        &lt;-<span class="st"> </span>Simulator<span class="op">$</span><span class="kw">new</span>(agent, horizon, simulations, </span>
<span id="cb5-6"><a href="#cb5-6"></a>                                                   <span class="dt">save_context =</span> <span class="ot">TRUE</span>, <span class="dt">do_parallel =</span> F)</span>
<span id="cb5-7"><a href="#cb5-7"></a>                                                   </span>
<span id="cb5-8"><a href="#cb5-8"></a>history                           &lt;-<span class="st"> </span>simulation<span class="op">$</span><span class="kw">run</span>()</span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a>Simulation horizon<span class="op">:</span><span class="st"> </span><span class="dv">10000</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>Number of simulations<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>Number of batches<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>Starting main loop.</span>
<span id="cb5-14"><a href="#cb5-14"></a>Completed simulation <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span><span class="dv">00</span><span class="op">:</span><span class="fl">01.781</span></span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a>u_dt                              &lt;-<span class="st"> </span>history<span class="op">$</span><span class="kw">get_data_table</span>()</span>
<span id="cb5-17"><a href="#cb5-17"></a></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="kw">print</span>(<span class="st">&quot;1a. Unbiased data generation.&quot;</span>)</span>
<span id="cb5-19"><a href="#cb5-19"></a>[<span class="dv">1</span>] <span class="st">&quot;1a. Unbiased data generation.&quot;</span></span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Sport:&quot;</span>,<span class="kw">sum</span>(u_dt[choice<span class="op">==</span><span class="dv">1</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(u_dt[choice<span class="op">==</span><span class="dv">1</span>]))) </span>
<span id="cb5-22"><a href="#cb5-22"></a>[<span class="dv">1</span>] <span class="st">&quot;Sport: 0.603323988786544&quot;</span>   <span class="co"># 0.6 CTR Sport - equals preferences!</span></span>
<span id="cb5-23"><a href="#cb5-23"></a></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Movie:&quot;</span>,<span class="kw">sum</span>(u_dt[choice<span class="op">==</span><span class="dv">2</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(u_dt[choice<span class="op">==</span><span class="dv">2</span>]))) </span>
<span id="cb5-25"><a href="#cb5-25"></a>[<span class="dv">1</span>] <span class="st">&quot;Movie: 0.501997602876548&quot;</span>   <span class="co"># 0.5 CTR Movie - equals preferences!</span></span></code></pre></div>
<p>The results are clear: when running the random policy, the logged data accurately represents visitor’s preferences.</p>
</div>
<div id="using-the-random-policys-offline-logged-data-to-evaluate-another-policy" class="section level2">
<h2>Using the random policy’s offline logged data to evaluate another policy</h2>
<p>The previous simulation produced a data.table with fully randomised historical data. Let’s use this data to evaluate some other policy:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a></span>
<span id="cb6-2"><a href="#cb6-2"></a>f                                 &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="st">&quot;reward ~ choice | X.1 + X.2&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a>bandit                            &lt;-<span class="st"> </span>OfflineReplayEvaluatorBandit<span class="op">$</span><span class="kw">new</span>(<span class="dt">formula =</span> f,</span>
<span id="cb6-4"><a href="#cb6-4"></a>                                                                      <span class="dt">data =</span> u_dt, </span>
<span id="cb6-5"><a href="#cb6-5"></a>                                                                      <span class="dt">k =</span> <span class="dv">2</span> , <span class="dt">d =</span> <span class="dv">2</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>policy                            &lt;-<span class="st"> </span>EpsilonGreedyPolicy<span class="op">$</span><span class="kw">new</span>(<span class="fl">0.1</span>)</span>
<span id="cb6-8"><a href="#cb6-8"></a>agent                             &lt;-<span class="st"> </span>Agent<span class="op">$</span><span class="kw">new</span>(policy, bandit, <span class="st">&quot;OfflineLinUCB&quot;</span>)</span>
<span id="cb6-9"><a href="#cb6-9"></a> </span>
<span id="cb6-10"><a href="#cb6-10"></a>simulation                        &lt;-<span class="st"> </span>Simulator<span class="op">$</span><span class="kw">new</span>(agent, horizon, simulations, <span class="dt">do_parallel =</span> F)</span>
<span id="cb6-11"><a href="#cb6-11"></a>history                           &lt;-<span class="st"> </span>simulation<span class="op">$</span><span class="kw">run</span>()</span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a>Simulation horizon<span class="op">:</span><span class="st"> </span><span class="dv">10000</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>Number of simulations<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>Number of batches<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>Starting main loop.</span>
<span id="cb6-17"><a href="#cb6-17"></a>Completed simulation <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span><span class="dv">00</span><span class="op">:</span><span class="fl">01.606</span></span>
<span id="cb6-18"><a href="#cb6-18"></a></span>
<span id="cb6-19"><a href="#cb6-19"></a>ru_dt                             &lt;-<span class="st"> </span>history<span class="op">$</span><span class="kw">get_data_table</span>()</span>
<span id="cb6-20"><a href="#cb6-20"></a> </span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="kw">print</span>(<span class="st">&quot;1b. Offline unbiased policy evaluation.&quot;</span>)</span>
<span id="cb6-22"><a href="#cb6-22"></a>[<span class="dv">1</span>] <span class="st">&quot;1b. Offline unbiased policy evaluation.&quot;</span></span>
<span id="cb6-23"><a href="#cb6-23"></a> </span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Sport:&quot;</span>,<span class="kw">sum</span>(ru_dt[choice<span class="op">==</span><span class="dv">1</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(ru_dt[choice<span class="op">==</span><span class="dv">1</span>])))</span>
<span id="cb6-25"><a href="#cb6-25"></a>[<span class="dv">1</span>] <span class="st">&quot;Sport: 0.602566799915843&quot;</span>   <span class="co"># 0.6 CTR Sport - equals preferences!</span></span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Movie:&quot;</span>,<span class="kw">sum</span>(ru_dt[choice<span class="op">==</span><span class="dv">2</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(ru_dt[choice<span class="op">==</span><span class="dv">2</span>]))) </span>
<span id="cb6-28"><a href="#cb6-28"></a>[<span class="dv">1</span>] <span class="st">&quot;Movie: 0.493589743589744&quot;</span>   <span class="co"># 0.5 CTR Movie - equals preferences!</span></span></code></pre></div>
<p>Accurate numbers again: clearly, the logged data from a randomizing policy can be used to test other ‘off-policy’ algorithms.</p>
</div>
<div id="generate-data-by-running-a-biased-online-policy" class="section level2">
<h2>Generate data by running a biased online policy</h2>
<p>Now suggest some editor just &quot;knows’ that men like Sport, and women like Movie. So some business logic was added to the site assigning Movie related articles, on average, to 75% of Female visitors, and Sport articles, on average, to 75% of Male visitors.</p>
<p>This business logic might be implemented through the following policy:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>BiasedPolicy                      &lt;-<span class="st"> </span>R6<span class="op">::</span><span class="kw">R6Class</span>(</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="dt">portable =</span> <span class="ot">FALSE</span>,</span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="dt">class =</span> <span class="ot">FALSE</span>,</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="dt">inherit =</span> RandomPolicy,</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="dt">public =</span> <span class="kw">list</span>(</span>
<span id="cb7-6"><a href="#cb7-6"></a>   <span class="dt">class_name =</span> <span class="st">&quot;BiasedPolicy&quot;</span>,</span>
<span id="cb7-7"><a href="#cb7-7"></a>   <span class="dt">get_action =</span> <span class="cf">function</span>(t, context) {</span>
<span id="cb7-8"><a href="#cb7-8"></a>     <span class="cf">if</span>(context<span class="op">$</span>X[<span class="dv">1</span>]<span class="op">==</span><span class="dv">1</span>) {           <span class="co"># 1: Male || 0: Female.</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>       prob                      &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.75</span>,<span class="fl">0.25</span>) <span class="co"># Editor thinks men like Sport articles more.</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>     } <span class="cf">else</span> {</span>
<span id="cb7-11"><a href="#cb7-11"></a>       prob                      &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.25</span>,<span class="fl">0.75</span>) <span class="co"># Editor thinks women like Movie articles more.</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>     }</span>
<span id="cb7-13"><a href="#cb7-13"></a>     action<span class="op">$</span>choice               &lt;-<span class="st"> </span><span class="kw">sample.int</span>(context<span class="op">$</span>k, <span class="dv">1</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>, <span class="dt">prob =</span> prob)</span>
<span id="cb7-14"><a href="#cb7-14"></a>      <span class="co"># Store the propensity score for the current action too:</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>      action<span class="op">$</span>propensity           &lt;-<span class="st"> </span>prob[action<span class="op">$</span>choice]</span>
<span id="cb7-16"><a href="#cb7-16"></a>      action</span>
<span id="cb7-17"><a href="#cb7-17"></a>    }</span>
<span id="cb7-18"><a href="#cb7-18"></a>  )</span>
<span id="cb7-19"><a href="#cb7-19"></a>) </span></code></pre></div>
<p>Now run this policy against the Bandit modeling actual visitor preferences:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a> </span>
<span id="cb8-2"><a href="#cb8-2"></a>policy                            &lt;-<span class="st"> </span>BiasedPolicy<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb8-3"><a href="#cb8-3"></a>bandit                            &lt;-<span class="st"> </span>ContextualBernoulliBandit<span class="op">$</span><span class="kw">new</span>(<span class="dt">weights =</span> weights)</span>
<span id="cb8-4"><a href="#cb8-4"></a>agent                             &lt;-<span class="st"> </span>Agent<span class="op">$</span><span class="kw">new</span>(policy, bandit, <span class="st">&quot;Random&quot;</span>)</span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a>simulation                        &lt;-<span class="st"> </span>Simulator<span class="op">$</span><span class="kw">new</span>(agent, horizon, simulations, </span>
<span id="cb8-7"><a href="#cb8-7"></a>                                                   <span class="dt">save_context =</span> <span class="ot">TRUE</span>, <span class="dt">do_parallel =</span> F)</span>
<span id="cb8-8"><a href="#cb8-8"></a>history                           &lt;-<span class="st"> </span>simulation<span class="op">$</span><span class="kw">run</span>()</span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>Simulation horizon<span class="op">:</span><span class="st"> </span><span class="dv">10000</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>Number of simulations<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>Number of batches<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>Starting main loop.</span>
<span id="cb8-14"><a href="#cb8-14"></a>Completed simulation <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span><span class="dv">00</span><span class="op">:</span><span class="fl">01.954</span></span>
<span id="cb8-15"><a href="#cb8-15"></a> </span>
<span id="cb8-16"><a href="#cb8-16"></a>b_dt                              &lt;-<span class="st"> </span>history<span class="op">$</span><span class="kw">get_data_table</span>()</span>
<span id="cb8-17"><a href="#cb8-17"></a></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="kw">print</span>(<span class="st">&quot;2a. Biased data generation.&quot;</span>)</span>
<span id="cb8-19"><a href="#cb8-19"></a>[<span class="dv">1</span>] <span class="st">&quot;2a. Biased data generation.&quot;</span></span>
<span id="cb8-20"><a href="#cb8-20"></a> </span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Sport:&quot;</span>,<span class="kw">sum</span>(b_dt[choice<span class="op">==</span><span class="dv">1</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(b_dt[choice<span class="op">==</span><span class="dv">1</span>]))) </span>
<span id="cb8-22"><a href="#cb8-22"></a>[<span class="dv">1</span>] <span class="st">&quot;Sport: 0.506446414182111&quot;</span>  <span class="co"># 0.5 CTR Sport - Simpson&#39;s paradox at work</span></span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Movie:&quot;</span>,<span class="kw">sum</span>(b_dt[choice<span class="op">==</span><span class="dv">2</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(b_dt[choice<span class="op">==</span><span class="dv">2</span>]))) </span>
<span id="cb8-25"><a href="#cb8-25"></a>[<span class="dv">1</span>] <span class="st">&quot;Movie: 0.600675138999206&quot;</span>  <span class="co"># 0.6 CTR Movie - Simpson&#39;s..</span></span></code></pre></div>
<p>Clearly, the BiasedPolicy gives rise to, well, biased results! If you’d only be able to look at the data, without knowing of the biased business logic, you’d falsely conclude Sports is more popular then Movies, overall.</p>
</div>
<div id="using-the-biased-policys-offline-logged-data-to-evaluate-another-policy" class="section level2">
<h2>Using the biased policy’s offline logged data to evaluate another policy</h2>
<p>This time, the simulation generated a data.table with biased data. Let’s see what happens if we use this data to evaluate some other policy:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>f                                 &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="st">&quot;reward ~ choice | X.1 + X.2&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a>bandit                            &lt;-<span class="st"> </span>OfflineReplayEvaluatorBandit<span class="op">$</span><span class="kw">new</span>(<span class="dt">formula =</span> f, </span>
<span id="cb9-3"><a href="#cb9-3"></a>                                                                      <span class="dt">data =</span> b_dt, </span>
<span id="cb9-4"><a href="#cb9-4"></a>                                                                      <span class="dt">k =</span> <span class="dv">2</span> , <span class="dt">d =</span> <span class="dv">2</span>)</span>
<span id="cb9-5"><a href="#cb9-5"></a>policy                            &lt;-<span class="st"> </span>EpsilonGreedyPolicy<span class="op">$</span><span class="kw">new</span>(<span class="fl">0.1</span>)</span>
<span id="cb9-6"><a href="#cb9-6"></a>agent                             &lt;-<span class="st"> </span>Agent<span class="op">$</span><span class="kw">new</span>(policy, bandit, <span class="st">&quot;rb&quot;</span>)</span>
<span id="cb9-7"><a href="#cb9-7"></a> </span>
<span id="cb9-8"><a href="#cb9-8"></a>simulation                        &lt;-<span class="st"> </span>Simulator<span class="op">$</span><span class="kw">new</span>(agent, horizon, simulations, <span class="dt">do_parallel =</span> F)</span>
<span id="cb9-9"><a href="#cb9-9"></a>history                           &lt;-<span class="st"> </span>simulation<span class="op">$</span><span class="kw">run</span>()</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a>Simulation horizon<span class="op">:</span><span class="st"> </span><span class="dv">10000</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>Number of simulations<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>Number of batches<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>Starting main loop.</span>
<span id="cb9-15"><a href="#cb9-15"></a>Completed simulation <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span><span class="dv">00</span><span class="op">:</span><span class="fl">01.478</span></span>
<span id="cb9-16"><a href="#cb9-16"></a></span>
<span id="cb9-17"><a href="#cb9-17"></a>rb_dt                             &lt;-<span class="st"> </span>history<span class="op">$</span><span class="kw">get_data_table</span>()</span>
<span id="cb9-18"><a href="#cb9-18"></a> </span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="kw">print</span>(<span class="st">&quot;2b. Offline biased policy evaluation.&quot;</span>)</span>
<span id="cb9-20"><a href="#cb9-20"></a>[<span class="dv">1</span>] <span class="st">&quot;2b. Offline biased policy evaluation.&quot;</span></span>
<span id="cb9-21"><a href="#cb9-21"></a> </span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Sport:&quot;</span>,<span class="kw">sum</span>(rb_dt[choice<span class="op">==</span><span class="dv">1</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(rb_dt[choice<span class="op">==</span><span class="dv">1</span>]))) </span>
<span id="cb9-23"><a href="#cb9-23"></a>[<span class="dv">1</span>] <span class="st">&quot;Sport: 0.5&quot;</span>  <span class="co"># 0.5 CTR Sport - Simpson&#39;s paradox, again!</span></span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Movie:&quot;</span>,<span class="kw">sum</span>(rb_dt[choice<span class="op">==</span><span class="dv">2</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(rb_dt[choice<span class="op">==</span><span class="dv">2</span>]))) </span>
<span id="cb9-26"><a href="#cb9-26"></a>[<span class="dv">1</span>] <span class="st">&quot;Movie: 0.602175277138674&quot;</span> <span class="co"># 0.6 CTR Sport - Simpson&#39;s paradox, again!</span></span></code></pre></div>
<p>The bias has propagated itself! So, does that mean it is not possible to use the “biased” data to evaluate other, off-line policies? That would severely limit the number of data sets for use in offline evaluation.</p>
</div>
<div id="repairing-the-biased-policys-logged-data-with-inverse-probability-weights" class="section level2">
<h2>Repairing the biased policy’s logged data with inverse probability weights</h2>
<p>Luckily, inverse propensity score weighting enables us to use propensity scores to obtain unbiased estimates of the original preferences of Male and Female visitors. That is, since our biased policy actually saved the propensity (“the probability of a unit being assigned to a particular treatment or category”) with which a certain category was chosen, we can correct for this bias while “replaying” the data. In “contextual”, there are several types of offline bandits that are able to use either such presaved propensities, or estimate propensities based on certain properties of the dataset. Here, we use its basic “<a href="https://github.com/Nth-iteration-labs/contextual/blob/master/R/bandit_offline_propensity_weighting.R">OfflinePropensityWeightingBandit</a>”:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>f                                 &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="st">&quot;reward ~ choice | X.1 + X.2 | propensity&quot;</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a>bandit                            &lt;-<span class="st"> </span>OfflinePropensityWeightingBandit<span class="op">$</span><span class="kw">new</span>(<span class="dt">formula =</span> f, <span class="dt">data =</span> b_dt,</span>
<span id="cb10-3"><a href="#cb10-3"></a>                                                                          <span class="dt">k =</span> <span class="dv">2</span> , <span class="dt">d =</span> <span class="dv">2</span>)</span>
<span id="cb10-4"><a href="#cb10-4"></a>policy                            &lt;-<span class="st"> </span>EpsilonGreedyPolicy<span class="op">$</span><span class="kw">new</span>(<span class="fl">0.1</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a>agent                             &lt;-<span class="st"> </span>Agent<span class="op">$</span><span class="kw">new</span>(policy, bandit, <span class="st">&quot;prop&quot;</span>)</span>
<span id="cb10-6"><a href="#cb10-6"></a> </span>
<span id="cb10-7"><a href="#cb10-7"></a>simulation                        &lt;-<span class="st"> </span>Simulator<span class="op">$</span><span class="kw">new</span>(agent, horizon, simulations, <span class="dt">do_parallel =</span> F)</span>
<span id="cb10-8"><a href="#cb10-8"></a>history                           &lt;-<span class="st"> </span>simulation<span class="op">$</span><span class="kw">run</span>()</span>
<span id="cb10-9"><a href="#cb10-9"></a></span>
<span id="cb10-10"><a href="#cb10-10"></a>Simulation horizon<span class="op">:</span><span class="st"> </span><span class="dv">10000</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>Number of simulations<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>Number of batches<span class="op">:</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>Starting main loop.</span>
<span id="cb10-14"><a href="#cb10-14"></a>Completed simulation <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span><span class="dv">00</span><span class="op">:</span><span class="fl">01.257</span></span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a>prop_dt                           &lt;-<span class="st"> </span>history<span class="op">$</span><span class="kw">get_data_table</span>()</span>
<span id="cb10-17"><a href="#cb10-17"></a> </span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="kw">print</span>(<span class="st">&quot;2c. Offline biased policy evaluation, inverse propensity scores.&quot;</span>)</span>
<span id="cb10-19"><a href="#cb10-19"></a>[<span class="dv">1</span>] <span class="st">&quot;2c. Offline biased policy evaluation, inverse propensity scores.&quot;</span></span>
<span id="cb10-20"><a href="#cb10-20"></a> </span>
<span id="cb10-21"><a href="#cb10-21"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Sport:&quot;</span>,<span class="kw">sum</span>(prop_dt[choice<span class="op">==</span><span class="dv">1</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(prop_dt[choice<span class="op">==</span><span class="dv">1</span>])))</span>
<span id="cb10-22"><a href="#cb10-22"></a>[<span class="dv">1</span>] <span class="st">&quot;Sport: 0.618266176609179&quot;</span>  <span class="co"># 0.6 CTR Sport, representing actual preferences - yay!</span></span>
<span id="cb10-23"><a href="#cb10-23"></a></span>
<span id="cb10-24"><a href="#cb10-24"></a><span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Movie:&quot;</span>,<span class="kw">sum</span>(prop_dt[choice<span class="op">==</span><span class="dv">2</span>]<span class="op">$</span>reward)<span class="op">/</span><span class="kw">nrow</span>(prop_dt[choice<span class="op">==</span><span class="dv">2</span>]))) </span>
<span id="cb10-25"><a href="#cb10-25"></a>[<span class="dv">1</span>] <span class="st">&quot;Movie: 0.496500591177808&quot;</span> <span class="co"># 0.5 CTR Movie, again, representing actual preferences..</span></span></code></pre></div>
<p>Hurray - inverse propensity score weighting has removed the bias! In other words: if and where possible, save propensity scores to your log files when experimenting with online policies. You will thank yourself at a later time!</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
